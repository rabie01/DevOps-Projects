name: Build and Deploy Java App

on:
  push:
    paths:
      - 'DevOps Project-01/Java-Login-App/**'
  workflow_dispatch:  # Enables manual triggering from the Actions tab

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    # defaults:
    #   run:
    #     working-directory: "DevOps Project-01/Java-Login-App"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package

      - name: List target contents for debugging
        run: ls -al target

      - name: Copy JAR to EC2
        env:
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "$EC2_SSH_KEY" > key.pem
          chmod 600 key.pem
          scp -o StrictHostKeyChecking=no -i key.pem target/*.jar $EC2_USER@$EC2_HOST:/home/$EC2_USER/
