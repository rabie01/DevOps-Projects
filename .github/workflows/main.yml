name: Build and Deploy Java WAR to ASG via S3

on:
  push:
    branches:
      - main  # or your main branch name

  workflow_dispatch:  # Allows manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    env:
      JAVA_VERSION: '17'
      WAR_NAME: 'dptweb-1.0.war'
      S3_KEY: 'artifacts/dptweb-1.0.war'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Build with Maven
        run: |
          cd 'DevOps Project-01/Java-Login-App'
          mvn clean package

      - name: Upload WAR to S3
        run: |
          aws s3 cp "DevOps Project-01/Java-Login-App/target/${{ env.WAR_NAME }}" \
            "s3://${{ secrets.S3_BUCKET }}/${{ env.S3_KEY }}" \
            --region "${{ secrets.AWS_REGION }}"

      - name: Start ASG Instance Refresh
        run: |
          aws autoscaling start-instance-refresh \
            --auto-scaling-group-name "${{ secrets.ASG_NAME }}" \
            --region "${{ secrets.AWS_REGION }}" \
            --preferences '{"MinHealthyPercentage": 100, "InstanceWarmup": 60}'

      - name: Confirm Refresh Started
        run: |
          aws autoscaling describe-instance-refreshes \
            --auto-scaling-group-name "${{ secrets.ASG_NAME }}" \
            --region "${{ secrets.AWS_REGION }}"

      # - name: Notify Slack (Optional)
      #   if: always()
      #   uses: slackapi/slack-github-action@v1.25.0
      #   with:
      #     payload: |
      #       {
      #         "text": "ðŸš€ WAR deployment completed and ASG refresh triggered for `${{ secrets.ASG_NAME }}`."
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
